<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <link rel="stylesheet" href="style.css" >
  <script type="text/javascript" src="https://unpkg.com/vue@next"></script>
  
</head>
<body>
  <header>
      <h1>ONLINE SHOP SITE--THE FIRST GROUP</h1>
  </header>
  
  <div id="main"> <!-- main 一定要放vue 前面!!!!!!!!!!!!!!!!!-->
    <button @click="openModal()">查看購物車</button>

    <div class="modal" v-if="isCartOpen">
      <div class="modal-content">
          <span class="close" @click="closeModal()">&times;</span>
          <h2>購物車內容</h2>
          <table border="1">
            <tr>
                <th>商品名稱</th>
                <th>單價</th>
                <th>數量</th>
                <th>操作</th>
            </tr>
            <tr v-for="(product, index) in cart">
                <td>{{ product.name }}</td>
                <td>{{ product.price }}</td>
                <td>
                  <input type="number" v-model="product.quantity" min="1" @change="updateCartPrice" />
                </td>
                <td>
                    <button @click="removeFromCart(product.id)">delete</button>
                </td>
            </tr>
        </table>
          <div>
            <div v-for="prod in cart">
              <p>{{ prod.name }} - 單價: ${{ prod.price }} - 數量: {{ prod.quantity }}</p>
            </div>
          </div>
          <div id="total-price">總價: {{ totalPrice }}</div>
      </div>
    </div>

    <div id="list" v-if="UI=='main'"><!-- main 一定要放vue 前面!!!!!!!!!!!!!!!!!-->
        <table border=1><!-- main 一定要放vue 前面!!!!!!!!!!!!!!!!!-->
            <tr>
              <td>序號</td>
              <td>商品名稱</td>
              <td>價格</td>
              <td>內容說明</td>
              <td>存貨數量</td>
            </tr>
            <tr v-for="product in dat">
              <td>{{product.id}}</td>
              <td>{{product.name}}</td>
              <td>{{product.price}}</td>
              <td>{{product.detail}}</td>
              <td>{{product.remain}}</td>
              <td>
                <button @click="addToCart(product.id)">加入購物車</button>
              </td>
            </tr>
          </table>
      </div>


      
  </div>



  <script>
    const productApp = Vue.createApp({
      data() {
        return {
          UI: 'main',
          dat: [],
          newProduct: {
            id: -1,
            name: '',
            price: '',
            detail: '',
            remain: ''
          },
          // cart control relate
          isCartOpen: false,
          cart : [],
          totalPrice: 0,
        }
      },
      methods: {
        loadList: function () {
          const that = this;
          fetch('controller.php?act=listProduct')
            .then(function (response) {
              return response.json();
            })
            .then(function (myJson) {
              that.dat = myJson;
            });
        },
        loadCart: function () {
          const that = this;
          fetch('controller.php?act=listCart')
            .then(function (response) {
              return response.json();
            })
            .then(function (myJson) {
              that.cart = myJson;
              that.updateCartPrice()
            });
        },
        openModal: function() {
          this.loadCart()
          this.isCartOpen = true
        },
        closeModal: function() {
          this.isCartOpen = false
        },
        updateCartPrice: function(){
          let total = 0;
          this.cart.forEach(item => {
            total = total+ item.price * item.quantity
        });
          this.totalPrice = total;
        },
        addToCart: function(productId){
          const that = this;

          const q = function(){
            const temp = that.cart.find((v) => v.product_id === productId)

            if (temp == undefined) {
              return 1;
            }

            return temp.quantity + 1;
          }()

          let url = "controller.php?act=addToCart";

          const dat =  new FormData();
          dat.append("dat", JSON.stringify({
                product_id: productId,
                quantity:q
              }))

          fetch( url, {
            method: 'POST',
            body: dat
          })
            .then(function (res) { return res.text(); })
            .then(function (data) {
              console.log(data);
              that.loadCart();
            })
        },
        removeFromCart: function(id) {
          const that = this;
          let url = "controller.php?act=removeFromCart&id=" + id;
          fetch(url, {
            method: 'POST'
          })
            .then(function (res) { return res.text(); })
            .then(function (data) {
              console.log(data);
              that.loadCart();
            })
        },
        setUI: function (page) {
          this.UI = page;
        }
        }  ,
      created() {
        this.loadList();
      }
    }).mount("#main");

  </script>
</body> 
</html>